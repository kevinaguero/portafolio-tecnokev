{% extends "base/base_portafolio.html" %}
{% load static %}
{% block titulo %}Proyectos{% endblock %}
{% block contenido %}
<!-- PROYECTOS -->
<section id="proyectos" class="reveal">
  <div class="container">
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4">
      <div class="reveal-left">
        <h2 class="section-title">Proyectos</h2>
        <p class="section-lead">Todos mis proyectos y trabajos. Filtra por categoría.</p>
      </div>
      
      {% if proyectos|length > 0 and categorias %}
      <div class="dropdown-filter-wrapper">
        <button class="btn-dropdown-filter" id="dropdown-proyectos-page" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-filter me-2"></i>
          <span class="filter-text">Todos</span>
          <i class="fas fa-chevron-down ms-2"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-filter" aria-labelledby="dropdown-proyectos-page">
          <li><a class="dropdown-item active" href="#" data-filter="*" data-dropdown="dropdown-proyectos-page">Todos</a></li>
          {% for categoria in categorias %}
          <li><a class="dropdown-item" href="#" data-filter="{{ categoria.id }}" data-dropdown="dropdown-proyectos-page">{{ categoria.nombre }}</a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    <!-- Grid de Cards -->
    <div class="row g-4" id="proyectos-grid">
      {% for proyecto in proyectos %}
      <div class="col-12 col-md-6 col-lg-4 proyecto-card" data-categorias="{% for cat in proyecto.categorias.all %}{{ cat.id }}{% if not forloop.last %} {% endif %}{% endfor %}">
        <div class="tk-card h-100 d-flex flex-column reveal">
          <img src="{{ proyecto.imagen.url }}" alt="{{ proyecto.titulo }}" class="card-img-top" style="height: 220px; object-fit: cover;" />
          <div class="p-4 d-flex flex-column flex-grow-1">
            <h5 class="fw-bold mb-1">{{ proyecto.titulo }}</h5>
            <p class="text-secondary small mb-3">
              {% for cat in proyecto.categorias.all %}
                {{ cat.nombre }}{% if not forloop.last %} • {% endif %}
              {% endfor %}
            </p>
            <!-- Descripción con scroll si es muy larga -->
            <div class="description flex-grow-1 mb-3" style="max-height:120px; overflow-y:auto;">
              {{ proyecto.descripcion|truncatechars:200 }}
            </div>
            <!-- Botones -->
            <div class="d-flex gap-2 mt-auto">
              {% if proyecto.titulo_boton and proyecto.link_boton %}
              <a href="{{ proyecto.link_boton }}" class="btn btn-sm btn-outline-light" target="_blank">
                {{ proyecto.titulo_boton }}
              </a>
              {% endif %}
              {% if proyecto.link_github %}
              <a href="{{ proyecto.link_github }}" class="btn btn-sm btn-outline-light" target="_blank">
                <i class="fab fa-github me-1"></i>Código
              </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <p class="text-center text-secondary">No hay proyectos publicados aún.</p>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- JavaScript para filtros con dropdown -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropdownItems = document.querySelectorAll('.dropdown-menu-filter .dropdown-item');
    const proyectoCards = document.querySelectorAll('.proyecto-card');

    console.log('Total cards:', proyectoCards.length);

    dropdownItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Obtener el dropdown al que pertenece
            const dropdownId = this.getAttribute('data-dropdown');
            const dropdownButton = document.getElementById(dropdownId);
            const filterText = dropdownButton.querySelector('.filter-text');
            
            // Remover active de todos los items del mismo dropdown
            const parentMenu = this.closest('.dropdown-menu-filter');
            parentMenu.querySelectorAll('.dropdown-item').forEach(btn => btn.classList.remove('active'));
            
            // Agregar active al item clickeado
            this.classList.add('active');
            
            // Actualizar el texto del botón
            filterText.textContent = this.textContent;

            const filterValue = this.getAttribute('data-filter');
            console.log('Filtrando por:', filterValue);

            proyectoCards.forEach(card => {
                const categorias = card.getAttribute('data-categorias');
                console.log('Card categorías:', categorias);
                
                if (filterValue === '*') {
                    // Mostrar todas
                    card.classList.remove('d-none');
                    card.style.display = '';
                } else if (categorias) {
                    // Dividir las categorías por espacios y verificar si incluye la categoría filtrada
                    const categoriasArray = categorias.trim().split(/\s+/).filter(c => c.length > 0);
                    console.log('Array de categorías:', categoriasArray);
                    
                    // Comparar como strings
                    const hasCategory = categoriasArray.some(cat => cat === filterValue);
                    console.log('Tiene categoría?', hasCategory);
                    
                    if (hasCategory) {
                        // Mostrar si tiene la categoría
                        card.classList.remove('d-none');
                        card.style.display = '';
                    } else {
                        // Ocultar si no tiene la categoría
                        card.classList.add('d-none');
                    }
                } else {
                    // Ocultar si no tiene categorías
                    card.classList.add('d-none');
                }
            });
        });
    });
});
</script>
{% endblock %}